---
# tasks file for web

- name: "Apache | Install Apache packages"
  yum: 
    name: httpd
    state: present
    enabled: yes
  notify: Restart Apache

- neme: "Apache | Include variables of Database Server in Webserver"
  include_vars: 
    dir: roles/db/vars
    extensions: yml

- name: "Apache | Create Virtualhost file for the site '{{ virtualhost_domain }}'"
  template: src=virtualhost.conf.j2 dest=/etc/httpd/vhost.d/{{ virtualhost_domain|replace('.','_')}}.conf
  

- name: "Apache | Creating Documentroot for the site '{{ virtualhost_domain }}'"
  file:
    path: "{{ app_path }}"
    state: directory
    mode: 0755
    owner: apache
    group: apache
   stat: path="{{ app_path }}"/wp-content/uploads
   register: wordpress_install
   
#- name: "Copy index.html"
#  template: src=index.html.j2 dest=/var/www/html/index.html
  
- name: "PHP | Install PHP packages"
  yum: state=present name={{ item }}
  with_items:
    - php
    - php-common
    - php-devel
    - php-fpm
    - php-gd
    - php-mbstring
    - php-mysqlnd
    - php-pdo
    - php-pgsql
    - php-process
    - php-recode
    - php-soap
    - php-xml
  notify: Restart Apache

#- name: "Copy PHP Info"
#  template: src=info.php.j2 dest=/var/www/html/info.php

block:
- name: "Wordpress | Download Wordpress"
  unarchive: remote_src=yes src="{{ LATEST_WP_URL }}" dest="{{ DOWNLOAD_PATH }}"

- name: "Wordpress | Rename download folder"
  command: cd /tmp;mv "{{ DOWNLOAD_PATH }}"/wordpress* "{{ DOWNLOAD_PATH }}"/wordpress

- name: "Wordpressv| Remove downloaded wordpress zipped file"
  command: cd /tmp; rm -f *.zip
  
- name: "Application | Copy wordpress files to the application document root"
  command: rsync -avP /tmp/wordpress/wordpress/ "{{ app_path }}"
  
- name: "Application | Create uploads folder for application"
  command: mkdir "{{ app_path }}"/wp-content/uploads
  
- neme: "Application | Create Database configuration file for the site '{{ virtualhost_domain }}'"
  template: src=wp-config.php.j2 dest="{{ app_path }}"/wp-config.php
  
- name: "Application | Permission set for the documentroot"
  file:
    path: "{{ app_path }}"
    state: directory
    mode: 0755
    owner: apache
    group: apache
    recurse: yes
      
 when: wordpress_install.stat.exits == False
...
